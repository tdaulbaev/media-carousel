import{getWidth}from"./utils";import debounce from"./utils/debounced";const invertValue=t=>t<0?Math.abs(t):-t;class MediaCarousel{constructor({container:t,touchContainer:e,options:i}){this.options={fps:Math.ceil(1e3/60),scrollVelocityRatio:1,debounceWaitTime:500,...i},this.container=t,this.touchContainer=e,this.totalWidth=getWidth(t)/2,this.playing=!1,this.offset=0,this.touchStartPosition=0,this.dragStartPosition=0,this.dragInProgress=!1,this.touchInProgress=!1,this.offsetPerTick=.5,this.onTouchStart=this.onTouchStart.bind(this),this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onDragStart=this.onDragStart.bind(this),this.onDragMove=this.onDragMove.bind(this),this.onDragEnd=this.onDragEnd.bind(this),this.connectObserver()}trackDragAndTouchEvents(){this.listenTouchEvents(),this.listenDragEvents()}play(){this.playing=!0,this.autoPlayDraw()}stop(){this.playing=!1}connectObserver(){var t;window.ResizeObserver&&(t=debounce(this.update.bind(this),this.options.debounceWaitTime),this.resizeObserver=new ResizeObserver(t),this.resizeObserver.observe(this.container))}disconnectObserver(){this.resizeObserver&&this.resizeObserver.disconnect()}update(){this.totalWidth=getWidth(this.container)/2}onTouchStart(t){this.stop(),this.touchInProgress=!0,t.preventDefault(),t.stopPropagation();t=t.touches[0];this.touchStartPosition=t.clientX}onTouchMove(t){t.preventDefault(),t.stopPropagation();var t=null==(t=t.touches)?void 0:t[0].clientX,e=this.offset+invertValue(this.touchStartPosition-t);this.touchStartPosition=t,this.setPosition(e),this.movePlayDraw()}onTouchEnd(t){t.preventDefault(),t.stopPropagation(),this.touchInProgress=!1,this.play()}onDragStart(t){this.stop(),t.preventDefault(),t.stopPropagation(),this.dragInProgress=!0,this.dragStartPosition=t.pageX}onDragMove(t){var e;t.preventDefault(),t.stopPropagation(),this.dragInProgress&&(e=t.pageX-this.dragStartPosition,e=this.offset+e,this.dragStartPosition=t.pageX,this.setPosition(e),this.movePlayDraw())}onDragEnd(t){t.preventDefault(),t.stopPropagation(),this.dragInProgress=!1,this.play()}listenTouchEvents(){this.touchContainer.addEventListener("touchstart",this.onTouchStart),this.touchContainer.addEventListener("touchmove",this.onTouchMove),this.touchContainer.addEventListener("touchend",this.onTouchEnd)}removeTouchEventsListener(){this.touchContainer.removeEventListener("touchstart",this.onTouchStart),this.touchContainer.removeEventListener("touchmove",this.onTouchMove),this.touchContainer.removeEventListener("touchend",this.onTouchEnd)}listenDragEvents(){this.touchContainer.addEventListener("mousedown",this.onDragStart),this.touchContainer.addEventListener("mousemove",this.onDragMove),this.touchContainer.addEventListener("mouseup",this.onDragEnd),this.touchContainer.addEventListener("mouseleave",this.onDragEnd)}removeDragEventsListener(){this.touchContainer.removeEventListener("mousedown",this.onDragStart),this.touchContainer.removeEventListener("mousemove",this.onDragMove),this.touchContainer.removeEventListener("mouseup",this.onDragEnd),this.touchContainer.removeEventListener("mouseleave",this.onDragEnd)}setPosition(t){return this.isMinOffset(t)?this.offset=t-this.totalWidth:this.isMaxOffset(t)?this.offset=-(this.totalWidth+t):this.offset=t}isMinOffset(t){return 0<=t}isMaxOffset(t){return Math.abs(t)>=this.totalWidth}scroll(t){t=this.offset+t*this.options.scrollVelocityRatio;this.setPosition(t)}calcNextPosition(){var t=this.offset-this.offsetPerTick;this.setPosition(t)}autoPlayDraw(){this.playing&&(this.timer=setTimeout(()=>{this.tickID=requestAnimationFrame(this.autoPlayDraw.bind(this)),this.container.style=`transform: translate3d(${this.offset}px, 0px, 0px);`,this.calcNextPosition()},this.options.fps))}movePlayDraw(){(this.dragInProgress||this.touchInProgress)&&(this.timer=setTimeout(()=>{this.tickID=requestAnimationFrame(this.movePlayDraw.bind(this)),this.container.style=`transform: translate3d(${this.offset}px, 0px, 0px);`},this.options.fps))}destroy(){this.removeTouchEventsListener(),this.removeDragEventsListener(),this.playing=!1,this.disconnectObserver(),this.timer&&(cancelAnimationFrame(this.tickID),clearTimeout(this.timer))}}export default MediaCarousel;export{invertValue};